<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Fees Management</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/stylesheets/fees.css" />
  </head>
  <body class="bg-light">
    <div id="main">
      <%- include('./partials/header') %>
      <div id="right">
        <%- include('./partials/right-header') %>

        <div class="container-fluid py-4">
          <!-- Header Section -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="d-flex flex-wrap gap-2 justify-content-md-end">
                      <span class="badge bg-danger fs-6 px-3 py-2">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        <span id="total-due-count"><%= (students.length + admissions.length) %></span>
                        Due
                      </span>
                      <span class="badge bg-warning text-dark fs-6 px-3 py-2">
                        <i class="fas fa-rupee-sign me-1"></i>
                        Total: ₹<span id="total-amount">0</span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Table Section -->
          <div class="row">
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="table-responsive">
                  <table
                    class="table table-striped table-hover mb-0"
                    id="feesTable"
                  >
                    <thead class="table-dark">
                      <tr>
                        <th class="py-3">
                          <i class="fas fa-user me-2"></i>Student Details
                        </th>
                        <th class="py-3 d-none d-md-table-cell">
                          <i class="fas fa-male me-2"></i>Father's Name
                        </th>
                        <th class="py-3">
                          <i class="fas fa-book me-2"></i>Course
                        </th>
                        <th class="py-3">
                          <i class="fas fa-calendar-alt me-2"></i>Due Date
                        </th>
                        <th class="py-3 d-none d-lg-table-cell">
                          <i class="fas fa-phone me-2"></i>Mobile
                        </th>
                        <th class="py-3">
                          <i class="fas fa-rupee-sign me-2"></i>Amount
                        </th>
                        <th class="py-3 text-center">
                          <i class="fas fa-cog me-2"></i>Action
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Dynamic Student Data -->
                      <% students.reverse().forEach((e, index) => { %>
                      <tr
                        class="student-row"
                        data-student-type="student"
                        data-amount="<%= e.due %>"
                        data-due-date="<%= e.dueDate %>"
                      >
                        <td class="py-3">
                          <div>
                            <a
                              href="/stdprofile/<%=e._id %>"
                              class="text-decoration-none fw-semibold text-primary"
                            >
                              <%= e.firstName %> <%= e.lastName %>
                            </a>
                            <div class="small text-muted d-md-none">
                              <i class="fas fa-male me-1"></i><%= e.fatherName
                              %>
                            </div>
                            <div class="small text-muted d-lg-none">
                              <i class="fas fa-phone me-1"></i><%=
                              e.contactNumber %>
                            </div>
                          </div>
                        </td>
                        <td class="py-3 d-none d-md-table-cell text-muted">
                          <%= e.fatherName %>
                        </td>
                        <td class="py-3">
                          <span class="badge bg-info text-dark">
                            <%= e.course.courseName %>
                          </span>
                        </td>
                        <td class="py-3">
                          <% const dueDate = new Date(e.dueDate); const today = new Date(); const isOverdue = dueDate < today; const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24)); %>
                          <div>
                            <span
                              class="<%= isOverdue ? 'text-danger fw-bold' : (daysDiff <= 7 ? 'text-warning fw-semibold' : 'text-success') %>"
                            >
                              <%= e.dueDate %>
                            </span>
                            <div class="small text-muted">
                              <%= isOverdue ? 'Overdue' : (daysDiff <= 7 ? 'Due Soon' : daysDiff + ' days left') %>
                            </div>
                          </div>
                        </td>
                        <td class="py-3 d-none d-lg-table-cell">
                          <a
                            href="tel:<%= e.contactNumber %>"
                            class="text-decoration-none"
                          >
                            <i class="fas fa-phone-alt me-1 text-success"></i>
                            <%= e.contactNumber %>
                          </a>
                        </td>
                        <td class="py-3">
                          <div>
                            <span class="fw-bold text-danger fs-5"
                              >₹<%= e.due %></span
                            >
                            <div class="small text-muted">Pending</div>
                          </div>
                        </td>
                        <td class="py-3 text-center">
                          <a
                            href="/edit/student/<%=e._id %>"
                            class="btn btn-success btn-sm"
                          >
                            <i class="fas fa-credit-card me-1"></i>
                            <span class="d-none d-sm-inline">Pay</span>
                          </a>
                        </td>
                      </tr>
                      <% }) %>

                      <!-- Dynamic Admission Data -->
                      <% admissions.reverse().forEach((e, index) => { %>
                      <tr
                        class="student-row"
                        data-student-type="admission"
                        data-amount="<%= e.due %>"
                        data-due-date="<%= e.dueDate %>"
                      >
                        <td class="py-3">
                          <div>
                            <a
                              href="/admprofile/<%=e._id %>"
                              class="text-decoration-none fw-semibold text-primary"
                            >
                              <%= e.firstName %> <%= e.lastName %>
                              <span class="badge bg-warning text-dark ms-1"
                                >Admission</span
                              >
                            </a>
                            <div class="small text-muted d-md-none">
                              <i class="fas fa-male me-1"></i><%= e.fatherName
                              %>
                            </div>
                            <div class="small text-muted d-lg-none">
                              <i class="fas fa-phone me-1"></i><%=
                              e.contactNumber %>
                            </div>
                          </div>
                        </td>
                        <td class="py-3 d-none d-md-table-cell text-muted">
                          <%= e.fatherName %>
                        </td>
                        <td class="py-3">
                          <span class="badge bg-info text-dark">
                            <%= e.course.courseName %>
                          </span>
                        </td>
                        <td class="py-3">
                          <% const dueDate = new Date(e.dueDate); const today = new Date(); const isOverdue = dueDate < today; const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24)); %>
                          <div>
                            <span
                              class="<%= isOverdue ? 'text-danger fw-bold' : (daysDiff <= 7 ? 'text-warning fw-semibold' : 'text-success') %>"
                            >
                              <%= e.dueDate %>
                            </span>
                            <div class="small text-muted">
                              <%= isOverdue ? 'Overdue' : (daysDiff <= 7 ? 'Due Soon' : daysDiff + ' days left') %>
                            </div>
                          </div>
                        </td>
                        <td class="py-3 d-none d-lg-table-cell">
                          <a
                            href="tel:<%= e.contactNumber %>"
                            class="text-decoration-none"
                          >
                            <i class="fas fa-phone-alt me-1 text-success"></i>
                            <%= e.contactNumber %>
                          </a>
                        </td>
                        <td class="py-3">
                          <div>
                            <span class="fw-bold text-danger fs-5"
                              >₹<%= e.due %></span
                            >
                            <div class="small text-muted">Pending</div>
                          </div>
                        </td>
                        <td class="py-3 text-center">
                          <a
                            href="/edit/admission/<%=e._id %>"
                            class="btn btn-success btn-sm"
                          >
                            <i class="fas fa-credit-card me-1"></i>
                            <span class="d-none d-sm-inline">Pay</span>
                          </a>
                        </td>
                      </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- No Results Message -->
          <div id="noResults" class="text-center py-5 d-none">
            <div class="card shadow-sm">
              <div class="card-body">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No students found</h4>
                <p class="text-muted">Try adjusting your search criteria</p>
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <div class="row mt-4">
            <div class="col-12">
              <nav aria-label="Student pagination">
                <ul class="pagination justify-content-center" id="pagination">
                  <!-- Pagination will be generated by JavaScript if needed -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Simple Custom Styles -->
    <style>
      /* Basic card styling */
      .card {
        border: none;
        border-radius: 8px;
      }

      /* Table styling */
      .table thead th {
        border: none;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.875rem;
      }

      .table tbody tr {
        border-bottom: 1px solid #e9ecef;
      }

      .table tbody tr:last-child {
        border-bottom: none;
      }

      /* Button styling */
      .btn {
        border-radius: 6px;
        font-weight: 500;
      }

      /* Badge styling */
      .badge {
        font-size: 0.75rem;
        font-weight: 500;
      }

      /* Dropdown styling */
      .dropdown-menu {
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-radius: 6px;
      }

      .dropdown-item {
        padding: 0.75rem 1rem;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .container-fluid {
          padding: 1rem;
        }

        .card-body {
          padding: 1rem;
        }

        .table thead th {
          font-size: 0.75rem;
          padding: 0.75rem 0.5rem;
        }

        .table tbody td {
          padding: 0.75rem 0.5rem;
        }
      }
    </style>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Calculate total amount from dynamic data
        let totalAmount = 0;
        document.querySelectorAll("[data-amount]").forEach((row) => {
          totalAmount += parseFloat(row.dataset.amount) || 0;
        });
        document.getElementById("total-amount").textContent =
          totalAmount.toLocaleString("en-IN");

        // Handle pay button clicks
        document.querySelectorAll(".btn-success").forEach((btn) => {
          btn.addEventListener("click", function () {
            this.innerHTML =
              '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
            this.disabled = true;
          });
        });

        // Show/hide no results message
        const tableBody = document.querySelector("#feesTable tbody");
        const noResults = document.getElementById("noResults");

        if (tableBody.children.length === 0) {
          document
            .querySelector(".table-responsive")
            .parentElement.classList.add("d-none");
          noResults.classList.remove("d-none");
        }
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
