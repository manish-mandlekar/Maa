<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Fees Management</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/stylesheets/fees.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      }

      html, body {
        height: 100%;
        width: 100%;
      }

      #main {
        width: 100%;
        min-height: 100vh;
        display: flex;
      }

      /* Right Content Styles */
      #right {
        flex: 1;
        width: 100%;
        min-height: 100vh;
        overflow-y: auto;
        background-color: #f8f9fa;
      }

      .popa {
        width: 100%;
        background-color: white;
        border-bottom: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .container {
        width: 100%;
        padding: 15px 20px;
      }

      .lo {
        display: flex;
        align-items: center;
        justify-content: flex-start;
      }

      .lo h2 {
        font-size: 24px;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
      }

      .ro {
        display: flex;
        gap: 20px;
        align-items: center;
        justify-content: flex-end;
      }

      .ro > i {
        font-size: 20px;
        color: #666;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .ro > i:hover {
        background-color: #f1f5fa;
        color: #315a51;
      }



      /* Enhanced Card Styles */
      .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        transition: transform 0.2s ease;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
      }

      /* Enhanced Table Styles */
      .table thead th {
        border: none;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 12px;
        background-color: #2c3e50 !important;
        color: white;
        padding: 15px 12px;
      }

      .table tbody tr {
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.2s ease;
      }

      .table tbody tr:hover {
        background-color: #f8f9fa;
      }

      .table tbody td {
        padding: 15px 12px;
        vertical-align: middle;
      }

      /* Enhanced Button Styles */
      .btn {
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
      }

      .btn-success {
        background: linear-gradient(135deg, #28a745, #20c997);
      }

      .btn-success:hover {
        background: linear-gradient(135deg, #218838, #1ba085);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
      }

      /* Enhanced Badge Styles */
      .badge {
        font-size: 13px;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 20px;
      }

      .badge.bg-danger {
        background: linear-gradient(135deg, #dc3545, #c82333) !important;
      }

      .badge.bg-warning {
        background: linear-gradient(135deg, #ffc107, #e0a800) !important;
      }

      .badge.bg-info {
        background: linear-gradient(135deg, #17a2b8, #138496) !important;
      }

      /* Responsive Design */
      @media (max-width: 767.98px) {
        .container-fluid {
          padding: 10px;
        }
        
        .card-body {
          padding: 15px;
        }
        
        .lo h2 {
          font-size: 20px;
          text-align: center;
        }
        
        .ro {
          justify-content: center;
          margin-top: 10px;
        }
        
        .table thead th {
          font-size: 11px;
          padding: 10px 8px;
        }
        
        .table tbody td {
          padding: 12px 8px;
        }
        
        .badge {
          font-size: 11px;
          padding: 6px 10px;
        }
      }

      @media (max-width: 575.98px) {
        .container-fluid {
          padding: 8px;
        }
        
        .lo h2 {
          font-size: 18px;
        }
        
        .table thead th {
          font-size: 10px;
          padding: 8px 6px;
        }
        
        .table tbody td {
          padding: 10px 6px;
          font-size: 14px;
        }
        
        .btn-sm {
          font-size: 12px;
          padding: 4px 8px;
        }
      }



      /* Loading Animation */
      .btn-loading {
        position: relative;
        pointer-events: none;
      }

      .btn-loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        margin: auto;
        border: 2px solid transparent;
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Status Indicators */
      .status-overdue {
        color: #dc3545 !important;
        font-weight: 700;
      }

      .status-due-soon {
        color: #ffc107 !important;
        font-weight: 600;
      }

      .status-upcoming {
        color: #28a745 !important;
        font-weight: 500;
      }
    </style>
  </head>
  <body class="bg-light">
    <div id="main">
      <%- include('./partials/header') %>

      <div id="right">
        <%- include('./partials/right-header') %>

        <div class="container-fluid py-4">
          <!-- Header Section -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-12">
                      <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center justify-content-md-end align-items-center">
                        <span class="badge bg-danger fs-6 px-3 py-2">
                          <i class="fas fa-exclamation-circle me-2"></i>
                          <span id="total-due-count"><%= (students.length + admissions.length) %></span>
                          Due
                        </span>
                        <span class="badge bg-warning text-dark fs-6 px-3 py-2">
                          <i class="fas fa-rupee-sign me-2"></i>
                          Total: â‚¹<span id="total-amount">0</span>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>



          <!-- Table Section -->
          <div class="row">
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="table-responsive">
                  <table class="table table-striped table-hover mb-0" id="feesTable">
                    <thead class="table-dark">
                      <tr>
                        <th class="py-3">
                          <i class="fas fa-user me-2"></i>Student Details
                        </th>
                        <th class="py-3 d-none d-md-table-cell">
                          <i class="fas fa-male me-2"></i>Father's Name
                        </th>
                        <th class="py-3 d-none d-sm-table-cell">
                          <i class="fas fa-book me-2"></i>Course
                        </th>
                        <th class="py-3">
                          <i class="fas fa-calendar-alt me-2"></i>Due Date
                        </th>
                        <th class="py-3 d-none d-lg-table-cell">
                          <i class="fas fa-phone me-2"></i>Mobile
                        </th>
                        <th class="py-3">
                          <i class="fas fa-rupee-sign me-2"></i>Amount
                        </th>
                        <th class="py-3 text-center">
                          <i class="fas fa-cog me-2"></i>Action
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Dynamic Student Data -->
                      <% students.reverse().forEach((e, index) => { %>
                      <tr
                        class="student-row"
                        data-student-type="student"
                        data-amount="<%= e.due %>"
                        data-due-date="<%= e.dueDate %>"
                      >
                        <td class="py-3">
                          <div>
                            <a
                              href="/stdprofile/<%=e._id %>"
                              class="text-decoration-none fw-semibold text-primary"
                            >
                              <%= e.firstName %> <%= e.lastName %>
                            </a>
                            <div class="small text-muted d-md-none mt-1">
                              <i class="fas fa-male me-1"></i><%= e.fatherName %>
                            </div>
                            <div class="small text-muted d-lg-none mt-1">
                              <i class="fas fa-phone me-1"></i><%= e.contactNumber %>
                            </div>
                            <div class="small text-muted d-sm-none mt-1">
                              <i class="fas fa-book me-1"></i><%= e.course.courseName %>
                            </div>
                          </div>
                        </td>
                        <td class="py-3 d-none d-md-table-cell text-muted">
                          <%= e.fatherName %>
                        </td>
                        <td class="py-3 d-none d-sm-table-cell">
                          <span class="badge bg-info text-dark">
                            <%= e.course.courseName %>
                          </span>
                        </td>
                        <td class="py-3">
                          <% 
                            const dueDate = new Date(e.dueDate); 
                            const today = new Date(); 
                            const isOverdue = dueDate < today; 
                            const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24)); 
                          %>
                          <div>
                            <span class="<%= isOverdue ? 'status-overdue' : (daysDiff <= 7 ? 'status-due-soon' : 'status-upcoming') %>">
                              <%= new Date(e.dueDate).toLocaleDateString('en-IN') %>
                            </span>
                            <div class="small text-muted">
                              <%= isOverdue ? 'Overdue by ' + Math.abs(daysDiff) + ' days' : (daysDiff <= 7 ? 'Due in ' + daysDiff + ' days' : daysDiff + ' days left') %>
                            </div>
                          </div>
                        </td>
                        <td class="py-3 d-none d-lg-table-cell">
                          <a href="tel:<%= e.contactNumber %>" class="text-decoration-none">
                            <i class="fas fa-phone-alt me-1 text-success"></i>
                            <%= e.contactNumber %>
                          </a>
                        </td>
                        <td class="py-3">
                          <div>
                            <span class="fw-bold text-danger fs-5">â‚¹<%= e.due.toLocaleString('en-IN') %></span>
                            <div class="small text-muted">Pending</div>
                          </div>
                        </td>
                        <td class="py-3 text-center">
                          <a
                            href="/edit/student/<%=e._id %>"
                            class="btn btn-success btn-sm pay-btn"
                            data-student-id="<%=e._id %>"
                          >
                            <i class="fas fa-credit-card me-1"></i>
                            <span class="d-none d-sm-inline">Pay</span>
                          </a>
                        </td>
                      </tr>
                      <% }) %>

                      <!-- Dynamic Admission Data -->
                      <% admissions.reverse().forEach((e, index) => { %>
                      <tr
                        class="student-row"
                        data-student-type="admission"
                        data-amount="<%= e.due %>"
                        data-due-date="<%= e.dueDate %>"
                      >
                        <td class="py-3">
                          <div>
                            <a
                              href="/admprofile/<%=e._id %>"
                              class="text-decoration-none fw-semibold text-primary"
                            >
                              <%= e.firstName %> <%= e.lastName %>
                              <span class="badge bg-warning text-dark ms-1">Admission</span>
                            </a>
                            <div class="small text-muted d-md-none mt-1">
                              <i class="fas fa-male me-1"></i><%= e.fatherName %>
                            </div>
                            <div class="small text-muted d-lg-none mt-1">
                              <i class="fas fa-phone me-1"></i><%= e.contactNumber %>
                            </div>
                            <div class="small text-muted d-sm-none mt-1">
                              <i class="fas fa-book me-1"></i><%= e.course.courseName %>
                            </div>
                          </div>
                        </td>
                        <td class="py-3 d-none d-md-table-cell text-muted">
                          <%= e.fatherName %>
                        </td>
                        <td class="py-3 d-none d-sm-table-cell">
                          <span class="badge bg-info text-dark">
                            <%= e.course.courseName %>
                          </span>
                        </td>
                        <td class="py-3">
                          <% 
                            const dueDate = new Date(e.dueDate); 
                            const today = new Date(); 
                            const isOverdue = dueDate < today; 
                            const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24)); 
                          %>
                          <div>
                            <span class="<%= isOverdue ? 'status-overdue' : (daysDiff <= 7 ? 'status-due-soon' : 'status-upcoming') %>">
                              <%= new Date(e.dueDate).toLocaleDateString('en-IN') %>
                            </span>
                            <div class="small text-muted">
                              <%= isOverdue ? 'Overdue by ' + Math.abs(daysDiff) + ' days' : (daysDiff <= 7 ? 'Due in ' + daysDiff + ' days' : daysDiff + ' days left') %>
                            </div>
                          </div>
                        </td>
                        <td class="py-3 d-none d-lg-table-cell">
                          <a href="tel:<%= e.contactNumber %>" class="text-decoration-none">
                            <i class="fas fa-phone-alt me-1 text-success"></i>
                            <%= e.contactNumber %>
                          </a>
                        </td>
                        <td class="py-3">
                          <div>
                            <span class="fw-bold text-danger fs-5">â‚¹<%= e.due.toLocaleString('en-IN') %></span>
                            <div class="small text-muted">Pending</div>
                          </div>
                        </td>
                        <td class="py-3 text-center">
                          <a
                            href="/edit/admission/<%=e._id %>"
                            class="btn btn-success btn-sm pay-btn"
                            data-student-id="<%=e._id %>"
                          >
                            <i class="fas fa-credit-card me-1"></i>
                            <span class="d-none d-sm-inline">Pay</span>
                          </a>
                        </td>
                      </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- No Results Message -->
          <div id="noResults" class="text-center py-5 d-none">
            <div class="card shadow-sm">
              <div class="card-body py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No students found</h4>
                <p class="text-muted">Try adjusting your search criteria or filter settings</p>
                <button class="btn btn-primary btn-sm" onclick="window.location.reload()">
                  <i class="fas fa-refresh me-1"></i>Refresh Page
                </button>
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <div class="row mt-4" id="paginationSection">
            <div class="col-12">
              <nav aria-label="Student pagination">
                <ul class="pagination justify-content-center" id="pagination">
                  <!-- Pagination will be generated by JavaScript if needed -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Calculate total amount from dynamic data
        let totalAmount = 0;
        document.querySelectorAll("[data-amount]").forEach((row) => {
          totalAmount += parseFloat(row.dataset.amount) || 0;
        });
        document.getElementById("total-amount").textContent = totalAmount.toLocaleString("en-IN");



        // Handle pay button clicks with loading state
        document.querySelectorAll(".pay-btn").forEach((btn) => {
          btn.addEventListener("click", function (e) {
            e.preventDefault();
            
            // Add loading state
            const originalContent = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
            this.disabled = true;
            this.classList.add('btn-loading');
            
            // Simulate processing time (remove this in production)
            setTimeout(() => {
              window.location.href = this.href;
            }, 1000);
          });
        });



        // Show/hide no results message on initial load
        const tableBody = document.querySelector("#feesTable tbody");
        const noResults = document.getElementById("noResults");

        if (tableBody.children.length === 0) {
          document.querySelector(".table-responsive").parentElement.classList.add("d-none");
          noResults.classList.remove("d-none");
        }

        // Add smooth scrolling for mobile
        if (window.innerWidth <= 768) {
          document.body.style.overflowX = 'hidden';
        }
      });



      // Handle window resize
      window.addEventListener('resize', function() {
        if (window.innerWidth <= 768) {
          document.body.style.overflowX = 'hidden';
        } else {
          document.body.style.overflowX = 'auto';
        }
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>